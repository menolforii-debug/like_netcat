#!/usr/bin/env php
<?php
declare(strict_types=1);

/**
 * Developer/ops CLI helper for cms.devel9.ru
 * Optional tool: site must not depend on it.
 *
 * Usage:
 *   php bin/cms migrate
 *   php bin/cms sections:list
 *   php bin/cms sections:add --parent-id=1 --english-name=news --title="Новости" [--sort=0]
 *   php bin/cms sections:add --title="Новый сайт"
 *   php bin/cms users:list
 *   php bin/cms users:add --login=admin --pass=admin [--role=admin]
 *   php bin/cms users:passwd --id=1 --pass=newpass
 *   php bin/cms users:role --id=1 --role=editor
 *   php bin/cms components:list
 */

$root = realpath(__DIR__ . '/..');
if ($root === false) {
    fwrite(STDERR, "Cannot resolve project root\n");
    exit(1);
}

require $root . '/app/bootstrap.php'; // provides $core, runs migrations already (idempotent)

$args = $argv;
array_shift($args);
$cmd = $args[0] ?? 'help';

function parse_kv_args(array $args): array {
    $out = [];
    foreach ($args as $a) {
        if (str_starts_with($a, '--') && str_contains($a, '=')) {
            [$k, $v] = explode('=', substr($a, 2), 2);
            $out[$k] = $v;
        }
    }
    return $out;
}

function help(): void {
    echo "cms.devel9.ru CLI\n\n";
    echo "Commands:\n";
    echo "  migrate\n";
    echo "  sections:list\n";
    echo "  sections:add --parent-id=1 --english-name=news --title=\"Новости\" [--sort=0]\n";
    echo "  sections:add --title=\"Новый сайт\" (creates site)\n";
    echo "  users:list\n";
    echo "  users:add --login=admin --pass=admin [--role=admin]\n";
    echo "  users:passwd --id=1 --pass=newpass\n";
    echo "  users:role --id=1 --role=editor\n";
    echo "  components:list\n";
    echo "\n";
}

switch ($cmd) {
    case 'help':
    case '--help':
    case '-h':
        help();
        exit(0);

    case 'migrate':
        // migrations run in bootstrap.php; just confirm
        echo "Migrations OK\n";
        exit(0);

    case 'sections:list': {
        $rows = DB::fetchAll(
            'SELECT id, parent_id, site_id, english_name, title, sort FROM sections ORDER BY parent_id ASC, sort ASC, id ASC'
        );
        foreach ($rows as $r) {
            $pid = $r['parent_id'] === null ? 'NULL' : (string)$r['parent_id'];
            $english = $r['english_name'] ?? '';
            echo "#{$r['id']} parent={$pid} site_id={$r['site_id']} english_name='{$english}' sort={$r['sort']} title=\"{$r['title']}\"\n";
        }
        exit(0);
    }

    case 'sections:add': {
        $kv = parse_kv_args($args);
        $parentId = isset($kv['parent-id']) ? (int) $kv['parent-id'] : null;
        $englishName  = $kv['english-name'] ?? '';
        $title = $kv['title'] ?? '';
        $sort  = (int)($kv['sort'] ?? 0);

        if ($title === '' || ($parentId !== null && $englishName === '')) {
            fwrite(STDERR, "Missing --title or --english-name\n");
            exit(1);
        }

        $repo = new SectionRepo();
        if ($parentId === null) {
            $id = $repo->createSite($title);
            $rootIndex = $repo->findRootByEnglishName($id, 'index');
            if ($rootIndex === null) {
                $repo->createSection($id, $id, 'index', 'Главная', 0, []);
            }
            $rootNotFound = $repo->findRootByEnglishName($id, '404');
            if ($rootNotFound === null) {
                $repo->createSection($id, $id, '404', '404', 0, []);
            }
            echo "Created site section id={$id}\n";
            exit(0);
        }

        $parent = $repo->findById($parentId);
        if (!$parent) {
            fwrite(STDERR, "Parent section not found by id: {$parentId}\n");
            exit(1);
        }

        $id = $repo->createSection($parentId, (int) $parent['site_id'], $englishName, $title, $sort);
        echo "Created section id={$id} parent={$parentId} english_name={$englishName}\n";
        exit(0);
    }

    case 'users:list': {
        $repo = new UserRepo();
        $rows = $repo->listAll();
        foreach ($rows as $row) {
            $role = isset($row['role']) ? (string) $row['role'] : 'admin';
            echo "#{$row['id']} login=\"{$row['login']}\" role=\"{$role}\"\n";
        }
        exit(0);
    }

    case 'users:add': {
        $kv = parse_kv_args($args);
        $login = $kv['login'] ?? '';
        $pass  = $kv['pass'] ?? '';
        $role = $kv['role'] ?? Auth::ROLE_ADMIN;

        if ($login === '' || $pass === '') {
            fwrite(STDERR, "Usage: users:add --login=... --pass=...\n");
            exit(1);
        }

        $id = Auth::createUser($login, $pass, $role);

        echo "Created user '{$login}' id={$id}\n";
        exit(0);
    }

    case 'users:passwd': {
        $kv = parse_kv_args($args);
        $id = isset($kv['id']) ? (int) $kv['id'] : 0;
        $pass = $kv['pass'] ?? '';
        if ($id <= 0 || $pass === '') {
            fwrite(STDERR, "Usage: users:passwd --id=... --pass=...\n");
            exit(1);
        }

        Auth::updateUserPassword($id, $pass);
        echo "Updated password for user id={$id}\n";
        exit(0);
    }

    case 'users:role': {
        $kv = parse_kv_args($args);
        $id = isset($kv['id']) ? (int) $kv['id'] : 0;
        $role = $kv['role'] ?? '';
        if ($id <= 0 || $role === '') {
            fwrite(STDERR, "Usage: users:role --id=... --role=...\n");
            exit(1);
        }

        Auth::updateUserRole($id, $role);
        echo "Updated role for user id={$id}\n";
        exit(0);
    }

    case 'components:list': {
        $repo = new ComponentRepo();
        $rows = $repo->listAll();
        foreach ($rows as $row) {
            echo "#{$row['id']} keyword=\"{$row['keyword']}\" name=\"{$row['name']}\"\n";
        }
        exit(0);
    }

    default:
        fwrite(STDERR, "Unknown command: {$cmd}\n\n");
        help();
        exit(1);
}

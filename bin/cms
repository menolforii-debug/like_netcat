#!/usr/bin/env php
<?php
declare(strict_types=1);

/**
 * Developer/ops CLI helper for cms.devel9.ru
 * Optional tool: site must not depend on it.
 *
 * Usage:
 *   php bin/cms migrate
 *   php bin/cms sections:list
 *   php bin/cms sections:add --parent-id=1 --english-name=news --title="Новости"
 *   php bin/cms users:add --login=admin --pass=admin
 */

$root = realpath(__DIR__ . '/..');
if ($root === false) {
    fwrite(STDERR, "Cannot resolve project root\n");
    exit(1);
}

require $root . '/app/bootstrap.php'; // provides $core, runs migrations already (idempotent)

$args = $argv;
array_shift($args);
$cmd = $args[0] ?? 'help';

function parse_kv_args(array $args): array {
    $out = [];
    foreach ($args as $a) {
        if (str_starts_with($a, '--') && str_contains($a, '=')) {
            [$k, $v] = explode('=', substr($a, 2), 2);
            $out[$k] = $v;
        }
    }
    return $out;
}

function help(): void {
    echo "cms.devel9.ru CLI\n\n";
    echo "Commands:\n";
    echo "  migrate\n";
    echo "  sections:list\n";
    echo "  sections:add --parent-id=1 --english-name=news --title=\"Новости\" [--sort=0]\n";
    echo "  users:add --login=admin --pass=admin\n";
    echo "\n";
}

switch ($cmd) {
    case 'help':
    case '--help':
    case '-h':
        help();
        exit(0);

    case 'migrate':
        // migrations run in bootstrap.php; just confirm
        echo "Migrations OK\n";
        exit(0);

    case 'sections:list': {
        $rows = $core->db->fetchAll(
            "SELECT id, parent_id, site_id, english_name, title, sort FROM sections ORDER BY parent_id ASC, sort ASC, id ASC"
        );
        foreach ($rows as $r) {
            $pid = $r['parent_id'] === null ? 'NULL' : (string)$r['parent_id'];
            $english = $r['english_name'] ?? '';
            echo "#{$r['id']} parent={$pid} site_id={$r['site_id']} english_name='{$english}' sort={$r['sort']} title=\"{$r['title']}\"\n";
        }
        exit(0);
    }

    case 'sections:add': {
        $kv = parse_kv_args($args);
        $parentId = isset($kv['parent-id']) ? (int) $kv['parent-id'] : null;
        $englishName  = $kv['english-name'] ?? '';
        $title = $kv['title'] ?? '';
        $sort  = (int)($kv['sort'] ?? 0);

        if ($title === '' || ($parentId !== null && $englishName === '')) {
            fwrite(STDERR, "Missing --title or --english-name\n");
            exit(1);
        }

        $repo = new SectionRepo();
        if ($parentId === null) {
            $id = $repo->createSite($title);
            echo "Created site section id={$id}\n";
            exit(0);
        }

        $parent = $repo->findById($parentId);
        if (!$parent) {
            fwrite(STDERR, "Parent section not found by id: {$parentId}\n");
            exit(1);
        }

        $id = $repo->createSection($parentId, (int) $parent['site_id'], $englishName, $title, $sort);
        echo "Created section id={$id} parent={$parentId} english_name={$englishName}\n";
        exit(0);
    }

    case 'users:add': {
        $kv = parse_kv_args($args);
        $login = $kv['login'] ?? '';
        $pass  = $kv['pass'] ?? '';

        if ($login === '' || $pass === '') {
            fwrite(STDERR, "Usage: users:add --login=... --pass=...\n");
            exit(1);
        }

        $hash = password_hash($pass, PASSWORD_DEFAULT);
        $core->db->exec(
            "INSERT INTO users(login, pass_hash) VALUES(?, ?)",
            [$login, $hash]
        );

        echo "Created user '{$login}'\n";
        exit(0);
    }

    default:
        fwrite(STDERR, "Unknown command: {$cmd}\n\n");
        help();
        exit(1);
}
